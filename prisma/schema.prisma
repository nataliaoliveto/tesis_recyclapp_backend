generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [citext(map: "citext")]
}

// * CRUD OK
model User {
  id                  String          @id @default(cuid())
  name                String          @db.VarChar(30)
  surname             String          @db.VarChar(30)
  mail                String          @unique @db.Citext
  phone               String          @db.VarChar(20)
  password            String          @db.VarChar(20)
  username            String          @unique @db.Citext
  imageId             String?         @unique
  isArchived          Boolean         @default(false)
  userType            UserType
  address             Address[]
  Advertisement       Advertisement[]
  ChatMessageReceived ChatMessage[]   @relation("chatReceiver")
  ChatMessageSent     ChatMessage[]   @relation("chatSender")
  Post                Post[]
  Rating              Rating?
  UserStore           UserStore?
  UserCustomer        UserCustomer?
  Image               Image?          @relation(fields: [imageId], references: [id], onDelete: SetNull)
}

// * ENUM OK
enum UserType {
  CUSTOMER
  STORE
}

// * CRUD OK
model Address {
  id           String      @id @default(cuid())
  street       String      @db.VarChar(50) //calle y numero
  flat         String      @db.VarChar(10) //dpto?
  city         String      @db.VarChar(50) //barrio/localidad
  state        String      @db.VarChar(50) //provincia/CABA
  latitude     Float
  longitude    Float
  greenPointId String?     @unique
  userId       String?
  isArchived   Boolean     @default(false)
  GreenPoint   GreenPoint? @relation(fields: [greenPointId], references: [id])
  User         User?       @relation(fields: [userId], references: [id])
}

// * CRUD OK
model UserStore {
  id          String    @id @default(cuid())
  displayName String    @unique @db.Citext
  userId      String    @unique
  User        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  Benefit     Benefit[]
}

// * CRUD OK
model UserCustomer {
  id              String    @id @default(cuid())
  pointsCurrent   Int       @default(0)
  pointsTotal     Int       @default(0)
  userId          String    @unique
  User            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  benefitsActive  Benefit[] @relation("benefitsActive")
  benefitsHistory Benefit[] @relation("benefitsHistory")
}

// * CRUD OK
model Rating {
  id         String  @id @default(cuid())
  text       String  @db.VarChar(255)
  value      Int
  userId     String  @unique
  isArchived Boolean @default(false)
  user       User    @relation(fields: [userId], references: [id])
}

// * CRUD OK
model Advertisement {
  id             String       @id @default(cuid())
  durationStart  DateTime     @db.Date
  durationEnd    DateTime     @db.Date
  displayName    String       @db.VarChar(30)
  text           String       @db.VarChar(255)
  imageId        String?      @unique
  userId         String
  subscriptionId String
  isArchived     Boolean      @default(false)
  subscription   Subscription @relation(fields: [subscriptionId], references: [id])
  user           User         @relation(fields: [userId], references: [id])
  Image          Image?       @relation(fields: [imageId], references: [id], onDelete: SetNull)
}

// * CRUD OK
model Subscription {
  id             String          @id @default(cuid())
  name           String          @unique @db.Citext
  amount         Float
  duration       Int
  isArchived     Boolean         @default(false)
  advertisements Advertisement[]
}

// * CRUD OK
model Benefit {
  id                  String         @id @default(cuid())
  name                String         @db.VarChar(20)
  type                BenefitType
  endDate             DateTime       @db.Date
  quantity            Int
  pointsCost          Int
  userStoreId         String
  isActive            Boolean        @default(true)
  isArchived          Boolean        @default(false)
  userStore           UserStore      @relation(fields: [userStoreId], references: [id])
  userCustomerActive  UserCustomer[] @relation("benefitsActive")
  userCustomerHistory UserCustomer[] @relation("benefitsHistory")
}

// TODO: EVALUATE RANGE OF TYPES - WHAT DOES EACH ONE REPRESENT?
// * ENUM OK
enum BenefitType {
  DISCOUNT
  PRODUCT
  DOUBLEPRODUCT
}

// * CRUD OK
model GreenPoint {
  id                String              @id @default(cuid())
  idpv              String              @unique @db.Citext
  name              String              @db.VarChar(50)
  availability      Json                @db.Json
  type              String              @db.VarChar(50)
  cooperative       String              @db.VarChar(200)
  hasOrganic        Boolean             @default(false)
  isArchived        Boolean             @default(false)
  Address           Address?
  materialComponent MaterialComponent[] @relation("GreenPointToMaterialComponent")
}

// * CRUD OK
model Organic {
  id            String  @id @default(cuid())
  name          String  @unique @db.Citext
  imageId       String? @unique
  isCompostable Boolean
  isArchived    Boolean @default(false)
  Image         Image?  @relation(fields: [imageId], references: [id], onDelete: SetNull)
}

// * CRUD OK
model MaterialProduct {
  id                String              @id @default(cuid())
  name              String              @unique @db.Citext
  imageId           String?             @unique
  isArchived        Boolean             @default(false)
  Image             Image?              @relation(fields: [imageId], references: [id], onDelete: SetNull)
  materialComponent MaterialComponent[] @relation("MaterialProductToMaterialComponent")
  Post              Post[]
}

// * CRUD OK
model MaterialComponent {
  id              String            @id @default(cuid())
  name            String            @unique @db.Citext
  recyclableType  RecyclableType
  description     String            @db.VarChar(1024)
  imageId         String?           @unique
  isArchived      Boolean           @default(false)
  Image           Image?            @relation(fields: [imageId], references: [id], onDelete: SetNull)
  GreenPoint      GreenPoint[]      @relation("GreenPointToMaterialComponent")
  MaterialProduct MaterialProduct[] @relation("MaterialProductToMaterialComponent")
}

// TODO: EVALUATE RANGE OF TYPES - WHAT DOES EACH ONE REPRESENT?
// * ENUM OK
enum RecyclableType {
  RECYCLABLE
  NO_RECYCLABLE
  DEPENDS
  ORGANIC
}

// * CRUD OK
model Post {
  id                String           @id @default(cuid())
  postNumber        Int              @unique @db.SmallInt
  quantity          Int              @db.SmallInt
  description       String           @db.VarChar(255)
  purpouse          PostPurpouse
  pointsAwared      Int
  userId            String
  materialProductId String
  imageId           String?          @unique
  isActive          Boolean          @default(true)
  isReserved        Boolean          @default(false)
  isArchived        Boolean          @default(false)
  Image             Image?           @relation(fields: [imageId], references: [id], onDelete: SetNull)
  Chat              Chat[]
  materialProduct   MaterialProduct  @relation(fields: [materialProductId], references: [id])
  userPost          User             @relation(fields: [userId], references: [id])
  PostCommitment    PostCommitment[]
}

// * ENUM OK
enum PostPurpouse {
  HAVE
  WANT
}

// * CRUD OK
model PostCommitment {
  id         String  @id @default(cuid())
  postId     String
  tokenCode  String  @db.VarChar(25)
  isActive   Boolean @default(true)
  isArchived Boolean @default(false)
  post       Post    @relation(fields: [postId], references: [id])
}

// * CRUD OK
model Chat {
  id          String        @id @default(cuid())
  postId      String
  startDate   DateTime      @db.Date
  endDate     DateTime?     @db.Date
  isActive    Boolean       @default(true)
  isArchived  Boolean       @default(false)
  post        Post          @relation(fields: [postId], references: [id])
  ChatMessage ChatMessage[]
}

// * CRUD OK
model ChatMessage {
  id         String   @id @default(cuid())
  timestamp  DateTime @default(now())
  message    String   @db.VarChar(255)
  senderId   String
  receiverId String
  chatId     String
  isArchived Boolean  @default(false)
  chat       Chat     @relation(fields: [chatId], references: [id])
  receiver   User     @relation("chatReceiver", fields: [receiverId], references: [id])
  sender     User     @relation("chatSender", fields: [senderId], references: [id])
}

model Image {
  id                String             @id @default(cuid())
  publicId          String             @unique
  format            String
  version           String
  url               String
  User              User?
  Advertisement     Advertisement?
  Organic           Organic?
  MaterialProduct   MaterialProduct?
  MaterialComponent MaterialComponent?
  Post              Post?
}
